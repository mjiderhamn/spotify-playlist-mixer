<html>
<head>
  <!-- Documentation https://doxdox.org/jmperez/spotify-web-api-js -->
  <script type="text/javascript" src="https://cdn.rawgit.com/JMPerez/spotify-web-api-js/53f7cec142f06a71f7a9ca55eb572ed1a67b1566/src/spotify-web-api.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.21.0/moment.js" integrity="sha256-9wM2SPsbZp8aQ0KHzSeg+KsAYGtc7GRTombqhhXvLSg=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="playlistmixer.js"></script>
  <title>Spotify Playlist Mixer</title>

  <script type="text/javascript">

    /** The categories to choose from */
    var categories = { // TODO Create GUI
      Bugg: true,
      Fox: true
    };

    /** The cycle of categories before starting over again */
    var cycle = ["Bugg", "Bugg", "Fox", "Fox"]; // TODO Create UI

    // TODO Create GUI for mixer.tracksBetweenCategories = IDs of the tracks to play when switching category. Could be a pause or some indicator. 

    // TODO Create GUI for mixer.tracksBetweenCycles = Tracks to play before starting over with a new cycle. Could be a silent pause or some indicator to switch partner.

    // ----------------------------------------------------------

    /** Tracks loaded into each category */
    var mixer = new Mixer();

    $(document).ready(function () {
      var params = parseParams();
      // TODO handle 'error'
      if('access_token' in params) {
        accessToken = params['access_token'];
        console.log("accessToken: " + accessToken);
        spotifyApi.setAccessToken(accessToken);
        $('#login').hide();
        initializeCategories();

        // TODO Defaults?
        // mixer.addTrackBetweenCategories(); // TODO Test data + callback
        mixer.addTrackBetweenCycles(Tracks.SILENCE_17s, function () {
          addTracksToListbox("betweenCycles", mixer.tracksBetweenCycles);
        });
      }
      else {
        $('#login').show();
        $('#loggedIn').hide();
      }
    });

    function initializeCategories() {
      $.each(categories, function(key, value) {
        $('#category').append($("<option></option>")
            .attr("value", key)
            .text(key));
      });
      // TODO Between categories
      // TODO Between cycles
    }

    // TODO Remove adding of test data
    function mattiasTestData() {
      mixer.appendTracksOfCategoryFromPlaylistUrl("Bugg", "spotify:user:mattiasj78:playlist:6lIfmLTd4BRjrqWYjVKEwA", populateListBoxes);
      mixer.appendTracksOfCategoryFromPlaylistUrl("Fox", "https://open.spotify.com/user/mattiasj78/playlist/4zzs5Px2dNbt9gOCg2lZU8", populateListBoxes);
      mixer.appendTracksOfCategoryFromPlaylistUrl("Fox", "https://open.spotify.com/user/mattiasj78/playlist/09NNLPLDSoqcHVHOwcB58r", populateListBoxes);
    }

    function addTracksFromPlaylist() {
      var category = $('#category').val();
      var uri = $('#playlist_uri').val();
      // TODO Add from provided URL to provided category
      
      mixer.appendTracksOfCategoryFromPlaylistUrl(category, uri, populateListBoxes);
      
      // mattiasTestData();
    }
    
    function addTracksToListbox(listboxId, tracks) {
      console.log("Adding " + tracks.length + " track(s) to " + listboxId);
      var listbox = $('#' + listboxId);
      $('option',  listbox).remove();
      $.each(tracks, function(index, track) {
        console.log("  Adding track to " + listboxId + ": " + track.id + " " + track.name); // JSON.stringify(track)
        listbox.append($("<option />")
            .attr("value", track.id)
            .text(track.name + (track.mixerCategory ? (" (" + track.mixerCategory + ')') : '')));
      });
    }
    
    function populateListBoxes() {
      addTracksToListbox("buggTracks", mixer.getTracksOfCategory("Bugg"));
      addTracksToListbox("foxTracks", mixer.getTracksOfCategory("Fox"));
      var totalBuggTime = mixer.getTotalTimeOfCategory("Bugg");
      var totalFoxTime = mixer.getTotalTimeOfCategory("Fox");
      $('#buggHeading').text("Bugg (" + mixer.getTracksOfCategory("Bugg").length + " tracks, " + formatMilliseconds(totalBuggTime) + ")");
      $('#foxHeading').text("Fox (" + mixer.getTracksOfCategory("Fox").length + " tracks, " + formatMilliseconds(totalFoxTime) + ")")
    }
    
    function formatMilliseconds(ms) {
      var duration = moment.duration(ms);
      return duration.hours() + " h " + duration.minutes() + " m " + duration.seconds() + " s";
      // duration.humanize(); ?
      // duration.as("hh:mm:ss"); ?
    }

    function mergeTracks() {
      mixer.mix(cycle);
      addTracksToListbox("result", mixer.result);
      $('#resultHeading').text("Result (" + mixer.result.length + " tracks, " + formatMilliseconds(mixer.getTotalTime(mixer.result)) + ")")
      
      var name = mixer.generateName(cycle);
      $('#playlist_name').val(name);

      // TODO Display information about unused tracks
    }
  </script>
  
  <!-- TODO Extract CSS -->
  <style>
    body {
      background: #1ed760; /* Spotify green */
      font-family: Circular,Helvetica,Arial,sans-serif;
    }
    
    select {
      width: 300px;
    }
    
    /*
    th, td {
      border: 1px black solid;
      padding: 0;
    }
    */
  </style>
  
</head>
<body>

<a href="https://github.com/mjiderhamn/spotify-playlist-mixer/">
  <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub">
</a>

<h1>Spotify Playlist Mixer</h1>

Using this playlist mixer, you can mix Spotify playlists of different categories according to your needs.
If you need to sort your source playlists by BPM (Beats Per Minute), you can use 
<a href="http://sortyourmusic.playlistmachinery.com/">Sort Your Music</a>.

<p id="login">
  <input type="button" value="Log in" onclick="login()"/>
</p>
<div id="loggedIn">
  <div>
    <h2>1. Add playlists</h2>
    Add playlists of different categories that you want mixed.
    You can see the tracks added into each category below.
    <br />
    <select id="category">

    </select>
    <input type="text" id="playlist_uri" placeholder="Playlist URL or URI" size="50" />
    <input type="button" value="Add tracks" onclick="addTracksFromPlaylist()"/>
  </div>
  <p>
    <a href="javascript:mattiasTestData()">Mattias test-data</a>
  </p>

  <h2>2. Mix</h2>
  <p>
    Click <input type="button" value="Mix!" onclick="mergeTracks()"/> to have the playlists randomly mixed.
    Check the results below.
  </p>

  <h2>3. Save</h2>
  <p>
    Click <input type="button" value="Save to new playlist" onclick="alert('New playlist: ' + mixer.saveResult($('#playlist_name').val()))"/>
    to save the mix playlist to your Spotify account.<br />
    Name of new playlist: <input id="playlist_name" placeholder="Name of new playlist" size="100"/>
  </p>
</div>
<hr />
<p>
<table>
  <tr>
    <th>Between categories</th>
    <th>Between cycles</th>
  </tr>
  <tr>
    <td>Tracks played when switching from one category to another</td>
    <td>Tracks played before starting the cycle of categories over again</td>
  </tr>
  <tr>
    <td>
      <select id="betweenCategories" size="3"></select>
    </td>
    <td>
      <select id="betweenCycles" size="3"></select>
    </td>
  </tr>
  <!-- TODO Build dynamically -->
  <tr>
    <th id="buggHeading">Bugg</th>
    <th id="foxHeading">Fox</th>
  </tr>
  <tr>
    <td>
      <select id="buggTracks" size="20"></select>
    </td>
    <td>
      <select id="foxTracks" size="20"></select>
    </td>
  </tr>
  <tr>
    <th colspan="2" id="resultHeading">Result</th>
  </tr>
  <tr>
    <th colspan="2">
      <select id="result" size="20"></select>
    </th>
  </tr>
</table>
</p>
</body>
</html>